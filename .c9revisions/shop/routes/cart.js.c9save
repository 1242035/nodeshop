{"ts":1369163445030,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"// Require needed modules\nvar db = require('../data');\n\n// Export functions\nmodule.exports = {\n\n    // Add to cart\n    addProduct: function(req, res) {\n    \n        // Get product from database for given id\n        db.findProductByID(req.params.id, function(err, product) { \n            if (err) {console.log(err)}\n            \n            // Initalise cart\n            if (!req.session.cart) { req.session.cart = {\n                products: {},\n                discounts: {}\n                };\n            }\n            \n            // Check if product already in cart\n            if (!req.session.cart.products[req.params.id]) {\n            \n                // Add product if not\n                req.session.cart.products[req.params.id] = {\n                    name: product.name,\n                    price: product.pricing.retail,\n                    seo: product.seo,\n                    quantity: 1  \n                };\n            \n            } else {\n            \n                // Increment count if already added\n                req.session.cart.products[req.params.id].quantity = req.session.cart.products[req.params.id].quantity + 1;\n            }\n            \n            // Send success\n            res.send('success');\n        \n        });\n    }\n};"]],"start1":0,"start2":0,"length1":0,"length2":1264}]],"length":1264}
{"contributors":[],"silentsave":false,"ts":1369164306206,"patch":[[{"diffs":[[0,");\n    }"],[1,",\n    \n    // Remove from cart\n    remProduct: function(req, res) {\n            \n            // Check if product already in cart\n            if (req.session.cart.products[req.params.id]) {\n\n                // Remove product \n                delete req.session.cart.products[req.params.id];\n            \n            } else if (req.session.cart.products[req.params.id].quantity >= 1) {\n            \n                // Reduce count if already added\n                req.session.cart.products[req.params.id].quantity = req.session.cart.products[req.params.id].quantity - 1;\n                \n            } else {\n                \n            res.json(500, {error: 'fail'});\n                \n            }\n            \n            // Send success\n            res.send('success');\n\n    },"],[0,"\n};"]],"start1":1253,"start2":1253,"length1":11,"length2":791}]],"length":2044,"saved":false}
{"ts":1369165067736,"patch":[[{"diffs":[[0," // "],[-1,"Send success\n            res.send('success'"],[1,"Respond with product data for cart\n            res.json(200, {name: product.name, price: product.pricing.retail, seo: product.seo, quantity: req.session.cart.products[req.params.id].quantity}"],[0,");\n "]],"start1":1185,"start2":1185,"length1":51,"length2":199},{"diffs":[[0,"               \n"],[1,"            // Send fail\n"],[0,"            res."]],"start1":2017,"start2":2017,"length1":32,"length2":57},{"diffs":[[0,"res."],[-1,"send('success'"],[1,"json(500, {error: 'fail'}"],[0,");\n\n"]],"start1":2186,"start2":2186,"length1":22,"length2":33}]],"length":2228,"saved":false}
{"ts":1369165218349,"patch":[[{"diffs":[[0,"00, "],[-1,"{name: product.name, price: product.pricing.retail, seo: product.seo, quantity: req.session.cart.products[req.params.id].quantity}"],[1,"req.session.cart"],[0,");\n "]],"start1":1246,"start2":1246,"length1":138,"length2":24}]],"length":2114,"saved":false}
{"ts":1369165326385,"patch":[[{"diffs":[[0,"nd with "],[1,"success and "],[0,"product "]],"start1":1194,"start2":1194,"length1":16,"length2":28},{"diffs":[[0,"0, {error: '"],[-1,"fail"],[1,"Item not in cart!"],[0,"'});\n       "]],"start1":1979,"start2":1979,"length1":28,"length2":41},{"diffs":[[0," // "],[-1,"Send success"],[1,"Respond with success and product data for cart"],[0,"\n   "]],"start1":2068,"start2":2068,"length1":20,"length2":54},{"diffs":[[0,"son("],[-1,"5"],[1,"2"],[0,"00, "],[-1,"{error: 'fail'}"],[1,"req.session.cart"],[0,");\n\n"]],"start1":2136,"start2":2136,"length1":28,"length2":29}]],"length":2174,"saved":false}
{"ts":1369165568642,"patch":[[{"diffs":[[0,"ck i"],[-1,"f product already in cart\n            if (req.session.cart.products[req.params.id]) {\n\n                // Remove product \n                delete req.session.cart.products[req.params.id];\n            \n            } else"],[1,"tem count\n           "],[0," if "]],"start1":1406,"start2":1406,"length1":226,"length2":29},{"diffs":[[0,"    "],[-1,"// Send fail\n            res.json(500, {error: 'Item not in cart!'})"],[1,"    // Remove product \n                delete req.session.cart.products[req.params.id]"],[0,";\n  "]],"start1":1742,"start2":1742,"length1":76,"length2":94}]],"length":1995,"saved":false}
{"ts":1369165588251,"patch":[[{"diffs":[[0," // Add "],[1,"product "],[0,"to cart\n"]],"start1":99,"start2":99,"length1":16,"length2":24},{"diffs":[[0," Remove "],[1,"product "],[0,"from car"]],"start1":1328,"start2":1328,"length1":16,"length2":24}]],"length":2011,"saved":false}
{"ts":1369165597203,"patch":[[{"diffs":[[0,"cts:"],[-1," {},\n                discounts:"],[0," {}\n"]],"start1":445,"start2":445,"length1":39,"length2":8}]],"length":1980,"saved":false}
{"ts":1369166213717,"patch":[[{"diffs":[[0,"cart) { "],[1,"\n                "],[0,"req.sess"]],"start1":395,"start2":395,"length1":16,"length2":33},{"diffs":[[0,"on.cart = {\n"],[1,"    "],[0,"            "]],"start1":429,"start2":429,"length1":24,"length2":28},{"diffs":[[0,"ucts: {}"],[1,",\n                    count: 0,\n                    total: 0"],[0,"\n       "]],"start1":465,"start2":465,"length1":16,"length2":76},{"diffs":[[0,"ty: 1  \n"],[-1,""],[0,"        "]],"start1":956,"start2":956,"length1":16,"length2":16},{"diffs":[[0,"             };\n"],[1,"                \n                // Count items\n                req.session.cart.count = req.session.cart.products.length;\n                \n                // Total cart\n                req.session.cart.products.forEach(function (product) {\n                    req.session.cart.total = req.session.cart.total + product.price;\n                });\n"],[0,"            \n   "]],"start1":967,"start2":967,"length1":32,"length2":378}]],"length":2407,"saved":false}
{"ts":1369166287936,"patch":[[{"diffs":[[0,"    "],[1,"\n"],[0,"    "],[-1,"\n                // Count items\n                req.session.cart.count = req.session.cart.products.length;\n  "],[1,"        } else {\n            \n                // Increment count if already added\n                req.session.cart.products[req.params.id].quantity = req.session.cart.products[req.params.id].quantity + 1;\n"],[0,"    "]],"start1":991,"start2":991,"length1":121,"length2":218},{"diffs":[[0," 1;\n            "],[-1,"  "],[1,"}"],[0,"\n               "]],"start1":1201,"start2":1201,"length1":34,"length2":33},{"diffs":[[0,"    "],[-1,"    // Total cart\n                req.session.cart.products.forEach(function (product) {\n       "],[1,"\n            // Count items\n"],[0,"    "]],"start1":1227,"start2":1227,"length1":104,"length2":36},{"diffs":[[0,"ems\n            "],[-1," "],[0,"req.session.cart"]],"start1":1255,"start2":1255,"length1":33,"length2":32},{"diffs":[[0,"on.cart."],[-1,"total"],[1,"count"],[0," = req.s"]],"start1":1280,"start2":1280,"length1":21,"length2":21},{"diffs":[[0,"art."],[-1,"total + product.price"],[1,"products.length"],[0,";\n  "]],"start1":1309,"start2":1309,"length1":29,"length2":23},{"diffs":[[0,"            "],[-1," "],[-1,"   });"],[0,"\n           "]],"start1":1330,"start2":1330,"length1":31,"length2":24},{"diffs":[[0,"    "],[-1,"\n            } else {\n            \n                // Increment count if already added\n                req.session.cart.products[req.params.id].quantity = req.session.cart.products[req.params.id].quantity + 1"],[1,"// Total cart\n            req.session.cart.products.forEach(function (product) {\n                req.session.cart.total = req.session.cart.total + product.price"],[0,";\n  "]],"start1":1351,"start2":1351,"length1":216,"length2":168},{"diffs":[[0,"e;\n            }"],[1,");"],[0,"\n            \n  "]],"start1":1514,"start2":1514,"length1":32,"length2":34},{"diffs":[[0,"  \n            }"],[-1,""],[0,""],[1,"\n            \n            // Count items\n            req.session.cart.count = req.session.cart.products.length;\n            \n            // Total cart\n            req.session.cart.products.forEach(function (product) {\n                req.session.cart.total = req.session.cart.total + product.price;\n            });"],[0,"\n            \n  "]],"start1":2228,"start2":2228,"length1":32,"length2":346}]],"length":2689,"saved":false}
{"ts":1369166742151,"patch":[[{"diffs":[[0,"         // "],[-1,"Count items"],[1,"Total cart"],[0,"\n           "]],"start1":1235,"start2":1235,"length1":35,"length2":34},{"diffs":[[0,"art."],[-1,"count = req.session.cart.products.length;"],[1,"products.forEach(function (product) {"],[0,"\n   "]],"start1":1283,"start2":1283,"length1":49,"length2":45},{"diffs":[[0,"    "],[-1,"\n "],[0,"    "],[-1,"       // Total cart\n            req.session.cart.products.forEach(function (product) {"],[1,"req.session.cart.count = req.session.cart.count + product.quantity;"],[0,"\n   "]],"start1":1333,"start2":1333,"length1":101,"length2":79},{"diffs":[[0," // "],[-1,"Count items"],[1,"Total cart"],[0,"\n   "]],"start1":2242,"start2":2242,"length1":19,"length2":18},{"diffs":[[0,"art."],[-1,"count = req.session.cart.products.length;"],[1,"products.forEach(function (product) {"],[0,"\n   "]],"start1":2282,"start2":2282,"length1":49,"length2":45},{"diffs":[[0,"    "],[-1,"\n "],[0,"    "],[-1,"       // Total cart\n            req.session.cart.products.forEach(function (product) {"],[1,"req.session.cart.count = req.session.cart.count + product.quantity;"],[0,"\n   "]],"start1":2332,"start2":2332,"length1":101,"length2":79}]],"length":2635,"saved":false}
{"contributors":[],"silentsave":false,"ts":1369174781969,"patch":[[{"diffs":[[0,"/data');"],[1,"\nvar _ = require('underscore');"],[0,"\n\n// Exp"]],"start1":46,"start2":46,"length1":16,"length2":47},{"diffs":[[0,"req, res) {\n"],[1,"        try {\n"],[0,"    \n       "]],"start1":179,"start2":179,"length1":24,"length2":38},{"diffs":[[0,"on.cart."],[-1,"products.forEach("],[1,"count = 0;\n            req.session.cart.total = 0;\n            _.each(req.session.cart.products, "],[0,"function"]],"start1":1324,"start2":1324,"length1":33,"length2":113},{"diffs":[[0,"ith "],[-1,"success and product data for cart\n            res.json(200,"],[1,"rendered cart\n            res.render('cart', {cart:"],[0," req"]],"start1":1668,"start2":1668,"length1":67,"length2":59},{"diffs":[[0,"ion.cart"],[1,"}"],[0,");\n     "]],"start1":1732,"start2":1732,"length1":16,"length2":17},{"diffs":[[0,"        });\n"],[1,"        } catch(err) {\n            console.log(err);\n        }\n"],[0,"    },\n    \n"]],"start1":1753,"start2":1753,"length1":24,"length2":87},{"diffs":[[0,"art."],[-1,"products.forEach("],[1,"count = 0;\n            req.session.cart.total = 0;\n            _.each(req.session.cart.products, "],[0,"func"]],"start1":2463,"start2":2463,"length1":25,"length2":105},{"diffs":[[0,"on.cart.total + "],[1,"("],[0,"product.price;\n "]],"start1":2719,"start2":2719,"length1":32,"length2":33},{"diffs":[[0,"+ (product.price"],[1," * product.quantity)"],[0,";\n            })"]],"start1":2733,"start2":2733,"length1":32,"length2":52}]],"length":2917,"saved":false}
{"ts":1369174831753,"patch":[[{"diffs":[[0,"total + "],[-1,"("],[0,"product."]],"start1":2727,"start2":2727,"length1":17,"length2":16},{"diffs":[[0,"quantity"],[-1,")"],[0,";\n      "]],"start1":2759,"start2":2759,"length1":17,"length2":16}]],"length":2915,"saved":false}
{"ts":1369174947123,"patch":[[{"diffs":[[0,"ssion.cart.total"],[-1," + "],[1,"+("],[0,"product.price * "]],"start1":2716,"start2":2716,"length1":35,"length2":34},{"diffs":[[0,"rice"],[-1," * "],[1,"*"],[0,"prod"]],"start1":2743,"start2":2743,"length1":11,"length2":9},{"diffs":[[0,"product.quantity"],[1,")"],[0,";\n            })"]],"start1":2748,"start2":2748,"length1":32,"length2":33}]],"length":2913,"saved":false}
{"ts":1369175082977,"patch":[[{"diffs":[[0,"ct.price"],[1," * product.quantity"],[0,";\n      "]],"start1":1605,"start2":1605,"length1":16,"length2":35},{"diffs":[[0,"otal"],[-1,"+("],[1," + "],[0,"prod"]],"start1":2747,"start2":2747,"length1":10,"length2":11},{"diffs":[[0,"ct.price"],[-1,"*"],[1," * "],[0,"product."]],"start1":2759,"start2":2759,"length1":17,"length2":19},{"diffs":[[0,"quantity"],[-1,")"],[0,";\n      "]],"start1":2778,"start2":2778,"length1":17,"length2":16}]],"length":2934,"saved":false}
{"ts":1369175135054,"patch":[[{"diffs":[[0,"on.cart.total + "],[1,"("],[0,"product.price * "]],"start1":1584,"start2":1584,"length1":32,"length2":33},{"diffs":[[0,"product.quantity"],[1,")"],[0,";\n            })"]],"start1":1617,"start2":1617,"length1":32,"length2":33},{"diffs":[[0,"total + "],[1,"("],[0,"product."]],"start1":2748,"start2":2748,"length1":16,"length2":17},{"diffs":[[0,"product.quantity"],[1,")"],[0,";\n            })"]],"start1":2773,"start2":2773,"length1":32,"length2":33}]],"length":2938,"saved":false}
{"contributors":[],"silentsave":false,"ts":1369273893156,"patch":[[{"diffs":[[0,"antity >"],[-1,"="],[0," 1) {\n  "]],"start1":2034,"start2":2034,"length1":17,"length2":16}]],"length":2937,"saved":false}
{"ts":1369274016436,"patch":[[{"diffs":[[0,"ams.id] = {\n"],[1,"                    id: product.id,\n"],[0,"            "]],"start1":834,"start2":834,"length1":24,"length2":60}]],"length":2973,"saved":false}
{"ts":1369274303299,"patch":[[{"diffs":[[0,"  try {\n    "],[1,"req.session.destroy()"],[0,"\n        // "]],"start1":197,"start2":197,"length1":24,"length2":45}]],"length":2994,"saved":false}
{"ts":1369274334922,"patch":[[{"diffs":[[0,"y {\n"],[-1,"    req.session.destroy()\n"],[0,"    "]],"start1":201,"start2":201,"length1":34,"length2":8}]],"length":2968,"saved":false}
{"ts":1369274459258,"patch":[[{"diffs":[[0,"ith "],[-1,"success and product data for"],[1,"rendered"],[0," car"]],"start1":2875,"start2":2875,"length1":36,"length2":16},{"diffs":[[0,"res."],[-1,"json(200,"],[1,"render('cart', {cart:"],[0," req"]],"start1":2905,"start2":2905,"length1":17,"length2":29},{"diffs":[[0,"ion.cart"],[1,"}"],[0,");\n\n    "]],"start1":2939,"start2":2939,"length1":16,"length2":17}]],"length":2961,"saved":false}
{"contributors":[],"silentsave":false,"ts":1369274960504,"patch":[[{"diffs":[[0,"               \n"],[1,"                if (_.size(req.session.cart.products[req.params.id]) = 0) {\n                    delete req.session.cart\n                } \n                \n"],[0,"            }\n  "]],"start1":2420,"start2":2420,"length1":32,"length2":188}]],"length":3117,"saved":false}
{"ts":1369274962935,"patch":[[{"diffs":[[0,"session.cart"],[1,";"],[0,"\n           "]],"start1":2543,"start2":2543,"length1":24,"length2":25}]],"length":3118,"saved":false}
{"ts":1369275087018,"patch":[[{"diffs":[[0,"   \n"],[-1,"                if (_.size(req.session.cart.products[req.params.id]) = 0) {\n                    delete req.session.cart;\n                } \n                \n"],[0,"    "]],"start1":2432,"start2":2432,"length1":165,"length2":8},{"diffs":[[0,");\n            \n"],[1,"            // Remove cart if empty\n            if (req.session.cart.count === 0) {\n                delete req.session.cart;\n            } \n            \n"],[0,"            // R"]],"start1":2835,"start2":2835,"length1":32,"length2":185}]],"length":3114,"saved":false}
{"ts":1369275387693,"patch":[[{"diffs":[[0,"n.cart;\n"],[1,"                res.render('cart');\n"],[0,"        "]],"start1":2968,"start2":2968,"length1":16,"length2":52}]],"length":3150,"saved":false}
{"ts":1369275485483,"patch":[[{"diffs":[[0,"count =="],[-1,"="],[0," 0) {\n  "]],"start1":2920,"start2":2920,"length1":17,"length2":16}]],"length":3149,"saved":false}
{"ts":1369275607676,"patch":[[{"diffs":[[0,"r('cart'"],[1,", {cart: undefined}"],[0,");\n     "]],"start1":3000,"start2":3000,"length1":16,"length2":35}]],"length":3168,"saved":false}
{"ts":1369275645275,"patch":[[{"diffs":[[0,"count =="],[1,"="],[0," 0) {\n  "]],"start1":2920,"start2":2920,"length1":16,"length2":17}]],"length":3169,"saved":false}
